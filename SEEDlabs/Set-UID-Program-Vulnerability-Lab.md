# SEEDlabs: Set-UID Program Vulnerability Lab

## Lab Description

Set-UID is an important security mechanism in Unix operating systems. When a Set-UID program is run, it assumes the owner's privileges. For example, if the program's owner is root, then when anyone runs this program, the program gains the root's privileges during its execution. Set-UID allows us to do many interesting things, but unfortunately, it is also the culprit of many bad things. Therefor, the objective of this lab is two-fold: (1) Appreciate its good side: understand why Set-UID is needed and how it is implimented. (2) Be aware of its bad side: understand its potential security problems.

## Lab Tasks

This is an exploration lab. Your main task is to "play" with the Set-UID mechanism in Linux, and write a lab report to describe your discoveries. You are required to accomplish the following tasks in Linux:

1. Figure out why "passwd" command needs to be Set-UID programs. What will happen if it is not? Please  copy  the  “passwd”  program  from  /usr/bin/passwd  to  folder  /home/seed.  Is  the copied  “passwd”  program  still  a  Set-UID  program?  Try  to  use  the  copied  program  to change your password. Will it be successful?

```sh
[09/23/21]seed@VM:~$ which passwd
/usr/bin/passwd
[09/23/21]seed@VM:~$ ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 53128 Mar 29  2016 /usr/bin/passwd
[09/23/21]seed@VM:~$ cp /usr/bin/passwd /home/seed
[09/23/21]seed@VM:~$ ls -l /home/seed/passwd 
-rwxr-xr-x 1 seed seed 53128 Sep 23 18:11 /home/seed/passwd
[09/23/21]seed@VM:~$ ./passwd 
Changing password for seed.
(current) UNIX password: 
passwd: Authentication token manipulation error
passwd: password unchanged
```
When copied `passwd` to `/home/seed`, it lost root's privileges. The program under the '/home/seed' cannot be used for changing passwords as can be seen above.

2. Run Set-UID shell programs in Linux, and describe and explain your observations.
a. Login  as  root,  copy  /bin/zsh  to  /tmp,  and  make  it  a  set-root-uid  program  using command  “chmod”  with  permission  4755.  Then  login  as  a  normal  user,  and  run /tmp/zsh. Will you get root privilege? Please describe your observation.

```sh
[09/23/21]seed@VM:/$ cd /tmp
[09/23/21]seed@VM:/tmp$ sudo su
root@VM:/tmp# cp /usr/bin/zsh /tmp/
root@VM:/tmp# chmod 4755 ./zsh 
root@VM:/tmp# ls -l ./zsh 
-rwsr-xr-x 1 root root 756476 Sep 23 18:57 ./zsh
root@VM:/tmp# exit
exit
[09/23/21]seed@VM:/tmp$ ./zsh 
VM# id
uid=1000(seed) gid=1000(seed) euid=0(root) groups=1000(seed),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)
```

As can be seen above, I can get a root privilege as a normal user.

b. Instead of copying `/bin/zsh`, this time, copy `/bin/bash` to `/tmp`, make it a set-root-uid program. Run `/tmp/bash` as a normal user. will you get root privilege? Please describe and explain your observation.

```sh
[09/23/21]seed@VM:/tmp$ sudo su
root@VM:/tmp# cp /bin/bash /tmp
root@VM:/tmp# chmod 4755 ./bash 
root@VM:/tmp# exit
exit
[09/23/21]seed@VM:/tmp$ ls -l ./bash
-rwsr-xr-x 1 root root 1109564 Sep 23 20:43 ./bash
[09/23/21]seed@VM:/tmp$ ./bash
bash-4.3$ id
uid=1000(seed) gid=1000(seed) groups=1000(seed),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)
```

While `zsh` can get root privilege, `bash` can not get the root priviege.

3.. (Setup for the rest of the tasks) As you can find out from the previous task, `/bin/bash` has certain built-in protection that prevent the abuse of the Set-UID mechanism. To see the life before such a protection scheme was implemented, we are going to use a different shell program called `/bin/zsh`. In some Linux distributions(such as Fedora and Ubuntu), `/bin/sh` is actually a symbolic link to `/bin/bash`. To use `zsh`, we need to link `/bin/sh` to `/bin/zsh`. The following instructions describe how to change the default shell to `zsh`.

```sh
[09/23/21]seed@VM:/$ su
Password: 
root@VM:/# cd /bin
root@VM:/bin# rm sh
root@VM:/bin# ln -s zsh sh
root@VM:/bin# ls -al sh
lrwxrwxrwx 1 root root 3 Sep 23 20:57 sh -> zsh
```
4. The PATH environment variable.
The `system(const char *cmd)` library function can be used to execute a command within a program. The way `system(cmd)` works is to invoke the `/bin/sh` program, and then let the shell program to execute `cmd`. Because of the shell program invoked, calling `system()` within a Set-UID program is extremely dangerous. This is because the actual behavior of the shell program can be affected by environment variables, such as `PATH`; these environment variables are under user's control. By changing these variables, malicious users can control the behavior of the Set-UID program.
In bash, you can change the PATH environment variable in the following way (this example adds the directory /home/seed to the beginning of the PATH environment variable):

$ export PATH=/home/seed:$PATH

In this task, login as the root account, and create and compile the following program using name “task3”.

```c
int main()
{
    system("ls");
    return 0;
}
```
```sh
[09/23/21]seed@VM:/$ cd /tmp
[09/23/21]seed@VM:/tmp$ sudo su
root@VM:/tmp# vim task3.c
root@VM:/tmp# gcc -o task3 task3.c
root@VM:/tmp# ls -l task3
-rwxr-xr-x 1 root root 7348 Sep 23 22:00 task3
root@VM:/tmp# chmod 4755 task3
root@VM:/tmp# ls -l task3
-rwsr-xr-x 1 root root 7348 Sep 23 22:00 task3
```
chmod 
Make the “task3” program to Set-UID using command “chmod” with permission 4755. This Set-UID “task3” program is supposed to execute the /bin/ls command when you execute it. Can you use your seed account and let this Set-UID program run your code instead of /bin/ls? For example, show the content of file “/etc/shadow”. Describe and explain your observations and solutions.
